#!/usr/bin/env bash

TMP_DIR=$(mktemp -d)

pushd $TMP_DIR
<% if scope['openondemand::proxy_server'] -%>
  export mellon_endpoint="https://<%= scope['openondemand::proxy_server'] %><%= scope['openondemand::mellon_endpoint_path'] %>"
<% else -%>
  export mellon_endpoint="https://<%= scope['openondemand::servername'] %><%= scope['openondemand::mellon_endpoint_path'] %>"
<% end -%>
<%= scope['apache::params::httpd_root'] %>/usr/libexec/mod_auth_mellon/mellon_create_metadata.sh "${mellon_endpoint}/metadata" "${mellon_endpoint}"
mv *.cert ./mellon.cert
mv *.key ./mellon.key
mv *.xml ./mellon_metadata.xml

openssl pkcs12 -export -inkey ./mellon.key -in ./mellon.cert -out ./mellon.pfx -passout pass:

popd
echo "Mellon files are generated at ${TMP_DIR}"
